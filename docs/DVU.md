---
title: Implementatie-instructie Keyper Approve voor DVU diensten
layout: default
---
## Implementatie-instructie Keyper Approve voor DVU diensten: Toestemming voor Energiedata via DVU

### Doel

Gebruikers van een applicatie moeten toestemming vragen aan de energiecontractant om energiedata op te halen. Dit gebeurt via een formulier op de website van de applicatie en een achterliggende API-call naar Keyper Approve.

---

### Stap 1: Formulier op de website

#### Velden aanvrager (invullend persoon)

- E-mailadres
- Organisatie
- Organisatie-id (EORI)
- Adres aan te vragen gebouw
  - Straatnaam
  - Huisnummer
  - Postcode
  - Plaats

#### Velden energiecontractant (approver via Keyper Approve)

- E-mailadres
- Organisatie&#x20;
- Organisatie-id (EORI)

Client-side validatie verplicht voor e-mail, EORI-nummer en verplichte velden. Helaas ondersteunt DVU op dit moment nog geen KVK nummers.

---

### Stap 2: Aanroepen van de Keyper API

[https://keyper-preview.poort8.nl/scalar/#tag/approval-links/POST/api/approval-links](https://keyper-preview.poort8.nl/scalar/#tag/approval-links/POST/api/approval-links)

Bij formulierverzending stuur je een POST-verzoek naar:

```
POST https://keyper-preview.poort8.nl/api/approval-links
Content-Type: application/json
```

#### JSON-body voorbeeld voor DVU op basis van formulierinvoer:

```json
{
  "authenticationMethods": ["eherkenning"],
  "requester": {
    "email": "<EMAIL_AANVRAGER>",
    "organization": "<ORGANISATIE_AANVRAGER>",
    "organizationId": "<EORI_AANVRAGER>"
  },
  "approver": {
    "email": "<EMAIL_ENERGIECONTRACTANT>",
    "organization": "<ORANISATIE_ENERGIECONTRACTANT>",
    "organizationId": "<EORI_ENERGIECONTRACTANT>"
  },
  "dataspace": {
    "name": "dvu",
    "policyUrl": "https://dvu-test.azurewebsites.net/api/policies/",
    "organizationUrl": "https://dvu-test.azurewebsites.net/api/organization-registry/__ORGANIZATIONID__",
    "resourceGroupUrl": "https://dvu-test.azurewebsites.net/api/resourcegroups/"
  },
  "description": "this keyper approve link was generated by bespaargarant",
  "reference": "<EIGEN_REF>",
  "expiresInSeconds": "<GELDIGHEID>",
  "redirectUrl": "https://dvu-test.azurewebsites.net/voegeengebouwtoe/__APPROVALLINKID__?adres=<ENCODED_ADRES>",
  "orchestration": {
    "notifications": {
      "approver": {
        "sendEmailAtEvent": ["ApprovalRequested"]
      },
      "requester": {
        "sendEmailAtEvent": ["ApprovalApproved"]
      }
    }
  }
}
```

- Gebruik URL encoding voor het adres in `redirectUrl`.
- Het respons-object bevat een veld “status”. Als deze “Active” is, dan is de link succesvol aangemaakt. De approver wordt  automatisch per email om reactie verzocht. 
- Kies een geldigheid (in seconden) voor hoe lang de link actief is, bijvoorbeeld 1 week (604.800 seconden).
- Gebruik een referentie voor gebruik in de app.

---

### Aandachtspunten

- **Redirect**: de huidige redirect is een placeholder. Wat is de juiste pagina voor afronding of vervolgstap voor de gebruiker? Moet deze terug naar een dashboard, gebouw-koppelscherm of bedankpagina?

- **Testomgeving**: de testomgeving voert **geen volledige verificaties** uit (zoals eHerkenning-authenticatie of validatie van organisatiegegevens). Gebruik dit uitsluitend voor functionele tests.

- Het **orchestration** object is nog in ontwikkeling. Hier worden nog (breaking) changes verwacht.

- Normaal gesproken wordt bij het aanmaken van een **Keyper Approve link** direct een `url` teruggestuurd waarmee het goedkeuringsproces kan worden begonnen. In de DVU Approve-flow moet de `approver` eerst zelf aanvullende informatie toevoegen via DVU. De `approver` wordt automatisch per mail genotificeerd en naar dit proces geleid. Daarom kan de Keyper Approve link die is aangemaakt niet direct gebruikt worden. Toon deze dus niet aan de gebruiker want deze kan hem niet succesvol afronden.
